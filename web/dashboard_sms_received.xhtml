<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./layout.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <ui:define name="metadata">
        <f:metadata>
            <f:event listener="#{interface_data_smsBean.initDashboard()}" type="preRenderView" />
        </f:metadata>
    </ui:define>
    <ui:define name="content">
        <f:view>
            <script type="text/javascript" src="resources/js/fusioncharts.js"></script>
            <script type="text/javascript" src="resources/js/fusioncharts.charts.js"></script>
            <script type="text/javascript" src="resources/js/fusioncharts.theme.fint.js"></script>
            <script type="text/javascript" src="resources/js/fusioncharts-jquery-plugin.js"></script>
            <script type="text/javascript" src="resources/js/fusioncharts.widgets.js"></script>
            <h:form rendered="#{loginBean.IsAllowed(0, 'View')}">
                <p:growl/>
                <p:fieldset legend="SMS Received">
                    <p:panelGrid columns="8" id="panelFilter">
                        <p:outputLabel value="Report Form:" />
                        <p:selectOneMenu id="report_form" value="#{interface_data_smsBean.report_form}" style="width:125px" converter="report_formConverter">
                            <f:selectItems value="#{report_formBean.getReport_forms_by_entrymode(2)}" var="item" itemLabel="#{item.report_form_name}" itemValue="#{item}"/>
                        </p:selectOneMenu>
                        <p:outputLabel value="Year:" />
                        <p:selectOneMenu id="year" value="#{interface_data_smsBean.report_period_year}" editable="true">
                                <f:selectItem itemLabel="#{generalUtilities.getCurrentYear()}" itemValue="#{generalUtilities.getCurrentYear()}" />
                                <f:selectItem itemLabel="#{generalUtilities.getCurrentYear()-1}" itemValue="#{generalUtilities.getCurrentYear()-1}" />
                                <f:selectItem itemLabel="#{generalUtilities.getCurrentYear()-2}" itemValue="#{generalUtilities.getCurrentYear()-2}" />
                                <f:selectItem itemLabel="#{generalUtilities.getCurrentYear()-3}" itemValue="#{generalUtilities.getCurrentYear()-3}" />
                            </p:selectOneMenu>
                        <p:outputLabel value="Week:" />
                        <p:selectOneMenu id="report_period_week" value="#{interface_data_smsBean.report_period_week}" editable="false">
                            <f:selectItems value="#{interface_data_smsBean.weekList}" var="w" itemLabel="#{w.report_form_code}" itemValue="#{w.is_active}"/>
                            <p:ajax/>
                        </p:selectOneMenu>
                        <p:commandButton id="cmdbSearch" value="APPLY FILTER" onclick="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()">
                            <p:ajax listener="#{interface_data_smsBean.refreshSMSreceivedDashboard(interface_data_smsBean.report_form,interface_data_smsBean.report_period_year,interface_data_smsBean.report_period_week)}" process="panelFilter" update="panelResultCharts panelResultTable"/>
                        </p:commandButton>
                        <p:commandButton id="cmdbReset" value="RESET FILTER" onclick="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()">
                            <p:ajax listener="#{interface_data_smsBean.resetDashboard()}" process="panelFilter" update="panelResultCharts panelResultTable"/>
                        </p:commandButton>
                    </p:panelGrid>
                    <h:panelGrid columns="2" id="panelResultCharts">
                        <h:panelGrid style="text-align: center">
                            <div id="chart-container1"></div>
                            <p:outputLabel value="#{interface_data_smsBean.count_n} SMS received out of #{interface_data_smsBean.count_d}"/>
                            <script type="text/javascript">
                                FusionCharts.ready(function () {
                                    var chartSMSReceived = new FusionCharts({
                                        type: 'angulargauge',
                                        renderAt: 'chart-container1',
                                        width: '400',
                                        height: '250',
                                        dataFormat: 'json',
                                        dataSource: {
                                            "chart": {
                                                "caption": "SMS Reporting Rate(%)",
                                                "subcaption": "W#{interface_data_smsBean.report_period_week} (#{generalUtilities.get_week_dates_from_year_and_week(interface_data_smsBean.report_period_year, interface_data_smsBean.report_period_week)})",
                                                "lowerLimit": "0",
                                                "upperLimit": "100",
                                                "lowerLimitDisplay": "0%",
                                                "upperLimitDisplay": "100%",
                                                "showValue": "1",
                                                "valueBelowPivot": "1",
                                                "numberSuffix": "%",
                                                "theme": "fint"
                                            },
                                            "colorRange": {
                                                "color": [
                                                    {
                                                        "minValue": "0",
                                                        "maxValue": "50",
                                                        "code": "#e44a00"
                                                    },
                                                    {
                                                        "minValue": "50",
                                                        "maxValue": "75",
                                                        "code": "#f8bd19"
                                                    },
                                                    {
                                                        "minValue": "75",
                                                        "maxValue": "100",
                                                        "code": "#1aaf5d"
                                                    }
                                                ]
                                            },
                                            "dials": {
                                                "dial": [{
                                                        "value": "#{interface_data_smsBean.perc_value}"
                                                    }]
                                            }
                                        }
                                    }).render();
                                });
                            </script>
                        </h:panelGrid>
                        <h:panelGrid>
                            <div id="chart-container2"></div>
                            <script type="text/javascript">
                                FusionCharts.ready(function () {
                                    var revenueChart = new FusionCharts({
                                        type: 'stackedbar2d',
                                        renderAt: 'chart-container2',
                                        width: '650',
                                        height: '400',
                                        dataFormat: 'json',
                                        dataSource: {
                                            "chart": {
                                                "caption": "Received SMS validation status",
                                                "subCaption": "W#{interface_data_smsBean.report_period_week} (#{generalUtilities.get_week_dates_from_year_and_week(interface_data_smsBean.report_period_year, interface_data_smsBean.report_period_week)})",
                                                "xAxisname": "Report Form",
                                                "yAxisName": "Number of SMS",
                                                "numberPrefix": "",
                                                "paletteColors": "#1aaf5d,#e44a00",
                                                "bgColor": "#ffffff",
                                                "borderAlpha": "20",
                                                "showCanvasBorder": "0",
                                                "usePlotGradientColor": "0",
                                                "plotBorderAlpha": "10",
                                                "legendBorderAlpha": "0",
                                                "legendShadow": "0",
                                                "valueFontColor": "#ffffff",
                                                "showXAxisLine": "1",
                                                "xAxisLineColor": "#999999",
                                                "divlineColor": "#999999",
                                                "divLineIsDashed": "1",
                                                "showAlternateVGridColor": "0",
                                                "subcaptionFontBold": "0",
                                                "subcaptionFontSize": "14",
                                                "showHoverEffect": "1"

                                            },
                                            "categories": #{interface_data_smsBean.categoriesChartString},
                                            "dataset": #{interface_data_smsBean.dataseriesChartString}
                                        }
                                    }).render();
                                });
                            </script>
                        </h:panelGrid>
                    </h:panelGrid>
                    <h:panelGrid columns="1" id="panelResultTable">
                        <p:dataTable id="table_received_sms" var="sms" value="#{interface_data_smsBean.received_SMSs}" draggableRows="false" 
                                     paginator="true" 
                                     paginatorTemplate="{Exporters}">
                            <f:facet name="header">
                                #{interface_data_smsBean.report_form.report_form_name}
                            </f:facet>
                            <f:facet name="{Exporters}">
                                <h:commandLink>
                                    <p:graphicImage name="images/excel.png" width="24"/>
                                    <p:dataExporter type="xls" target="table_received_sms" fileName="received_sms" />
                                </h:commandLink>
                                <h:commandLink>
                                    <p:graphicImage name="images/pdf.png" width="24"/>
                                    <p:dataExporter type="pdf" target="table_received_sms" fileName="received_sms"/>
                                </h:commandLink>
                                <h:commandLink>
                                    <p:graphicImage name="images/csv.png" width="24"/>
                                    <p:dataExporter type="csv" target="table_received_sms" fileName="received_sms" />
                                </h:commandLink>
                                <h:commandLink>
                                    <p:graphicImage name="images/xml.png" width="24"/>
                                    <p:dataExporter type="xml" target="table_received_sms" fileName="received_sms" />
                                </h:commandLink>
                            </f:facet>
                            <p:column headerText="Health Facility">
                                <h:outputText value="#{interface_data_smsBean.getEntityNameByPhone(sms.phone)}" />
                            </p:column>
                            <p:column headerText="Sender">
                                <h:outputText value="#{sms.phone}" />
                            </p:column>
                            <p:column headerText="Date">
                                <h:outputText value="#{sms.add_date}">
                                    <f:convertDateTime pattern="dd-MM-yyyy HH:mm" timeZone="EAT"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Status">
                                <h:outputText value="#{sms.status_f}" rendered="#{sms.status_f=='OK'}"/>
                                <h:outputText value="#{sms.status_f}" style="color: red" rendered="#{sms.status_f=='ERR'}"/>
                            </p:column>
                            <p:column headerText="Message">
                                <h:outputText value="#{sms.sms}" rendered="#{sms.status_f=='OK'}"/>
                                <h:outputText value="#{sms.sms}" style="color: red" rendered="#{sms.status_f=='ERR'}"/>
                            </p:column>
                        </p:dataTable>
                    </h:panelGrid>
                </p:fieldset>
            </h:form>
        </f:view>
        <p:ajaxStatus style="display:block;margin-bottom:2em;height:24px;">
            <f:facet name="default">
                <h:outputText value="Status: StandBy" />
            </f:facet>

            <f:facet name="start">

            </f:facet>

            <f:facet name="complete">
                <h:outputText value="Status: Completed" />
            </f:facet>
        </p:ajaxStatus>

        <p:ajaxStatus onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()" />

        <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
            <p:graphicImage name="/images/ajax-loader.gif" />
        </p:dialog>
    </ui:define>

</ui:composition>
